{% if interface.enabled == true %}
interface {{ interface.name }}
{% if interface.description | length > 1 %}
   description {{ interface.description }}
{% else %}
   description {{ interface.name }}
{% endif %}
{% set valid_addrs = interface.ip_addresses | selectattr("address", "defined") | list %}
{% if valid_addrs | length > 0 %}
{% for addr in valid_addrs %}
{% if '.' in addr["address"] %}
   ip address {{ addr["address"] }}
{% elif ':' in addr["address"] %}
   ipv6 address {{ addr["address"] }}
{% endif %}
{% endfor %}
{# OSPF configuration if relevant #}
{% if 'ospf' in config_context and interface['cf_ospf_area'] is not none %}
{% set ospf = config_context['ospf'] %}
{% if 'ipv4' in ospf %}
   ip ospf {{ ospf['ipv4']['process_id'] }} area {{ interface['cf_ospf_area'] }}
{% if interface['cf_ospf_network_type'] is not none %}
   ip ospf network {{ interface['cf_ospf_network_type'] }}
{% endif %}
{% endif %}
{% if 'ipv6' in ospf %}
   ipv6 ospf {{ ospf['ipv6']['process_id'] }} area {{ interface['cf_ospf_area'] }}
{% endif %}
{% endif %}
!
{% elif interface.mode == "TAGGED" %}
{% macro compress_vlan_list(vlans) -%}
{% set vlans = vlans | map(attribute='vid') | map('int') | sort %}
{% set output = "" %}
{% set start = vlans[0] %}
{% set end = start %}
{% for vid in vlans[1:] %}
{% if vid == end + 1 %}
{% set end = vid %}
{% else %}
{% if output != "" %}
{% set output = output ~ ',' %}
{% endif %}
{% if start == end %}
{% set output = output ~ start|string %}
{% else %}
{% set output = output ~ start|string ~ '-' ~ end|string %}
{% endif %}
{% set start = vid %}
{% set end = vid %}
{% endif %}
{% endfor %}
{% if output != "" %}
{% set output = output ~ ',' %}
{% endif %}
{% if start == end %}
{{ output ~ start }}
{% else %}
{{ output ~ start ~ '-' ~ end }}
{% endif %}
{% endmacro %}
   switchport trunk allowed vlan {{ compress_vlan_list(interface.tagged_vlans) }}
   switchport mode trunk
{% if interface.label == 'MLAG' %}
   switchport trunk group MLAG
{% endif %}
!
{% elif interface.mode == "TAGGED_ALL" %}
   switchport mode trunk
{% elif interface.mode == "ACCESS" %}
{% if interface.untagged_vlan.vid is defined %}
   switchport access vlan {{ interface.untagged_vlan.vid }}
{% endif %}
{% if interface.cf_mlag_interface == true %}
   mlag {{ interface.name | replace ("Port-Channel", "") }}
{% endif %}
!
{% else %}
   no ip address
!
{% endif %}
{% elif interface.enabled == false %}
interface {{ interface.name }}
   shutdown
!
{% endif %}