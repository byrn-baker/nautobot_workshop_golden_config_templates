{% if interface.enabled == true %}
interface {{ interface.name }}
{% if interface.description | length > 1 %}
   description {{ interface.description }}
{% else %}
   description {{ interface.name }}
{% endif %}
{% set valid_addrs = interface.ip_addresses | selectattr("address", "defined") | list %}
{% if valid_addrs | length > 0 %}
{% for addr in valid_addrs %}
{% if '.' in addr["address"] %}
   ip address {{ addr["address"] }}
{% elif ':' in addr["address"] %}
   ipv6 address {{ addr["address"] }}
{% endif %}
{% endfor %}
{# OSPF configuration if relevant #}
{% if 'ospf' in config_context and interface['cf_ospf_area'] is not none %}
{% set ospf = config_context['ospf'] %}
{% if 'ipv4' in ospf %}
   ip ospf {{ ospf['ipv4']['process_id'] }} area {{ interface['cf_ospf_area'] }}
{% if interface['cf_ospf_network_type'] is not none %}
   ip ospf network {{ interface['cf_ospf_network_type'] }}
{% endif %}
{% endif %}
{% if 'ipv6' in ospf %}
   ipv6 ospf {{ ospf['ipv6']['process_id'] }} area {{ interface['cf_ospf_area'] }}
{% endif %}
{% endif %}
!
{% elif interface.mode == "TAGGED" %}
{% macro compress_vlan_list(vlans) %}
{% set vids = vlans | map(attribute='vid') | map('int') | sort %}
{% set ns = namespace(output='', start=vids[0], end=vids[0]) %}
{% for vid in vids[1:] %}
{% if vid == ns.end + 1 %}
{% set ns.end = vid %}
{% else %}
{% if ns.output != '' %}
{% set ns.output = ns.output ~ ',' %}
{% endif %}
{% if ns.start == ns.end %}
{% set ns.output = ns.output ~ ns.start %}
{% else %}
{% set ns.output = ns.output ~ ns.start ~ '-' ~ ns.end %}
{% endif %}
{% set ns.start = vid %}
{% set ns.end = vid %}
{% endif %}
{% endfor %}
{% if ns.output != '' %}
{% set ns.output = ns.output ~ ',' %}
{% endif %}
{% if ns.start == ns.end %}
{{ ns.output ~ ns.start }}
{% else %}
{{ ns.output ~ ns.start ~ '-' ~ ns.end }}
{% endif %}
{% endmacro %}
   switchport trunk allowed vlan {{ compress_vlan_list(interface.tagged_vlans) }}
   switchport mode trunk
{% if interface.label == 'MLAG' %}
   switchport trunk group MLAG
{% endif %}
!
{% elif interface.mode == "TAGGED_ALL" %}
   switchport mode trunk
{% elif interface.mode == "ACCESS" %}
{% if interface.untagged_vlan.vid is defined %}
   switchport access vlan {{ interface.untagged_vlan.vid }}
{% endif %}
{% if interface.cf_mlag_interface == true %}
   mlag {{ interface.name | replace ("Port-Channel", "") }}
{% endif %}
!
{% else %}
   no ip address
!
{% endif %}
{% elif interface.enabled == false %}
interface {{ interface.name }}
   shutdown
!
{% endif %}